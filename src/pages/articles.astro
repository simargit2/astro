---
export const prerender = true;
import Navbar from "../components/Navbar.astro";
import Footer from "../components/Footer.astro";
import '../styles/global.css';

// Utility function for slug
const createSlug = (text) => {
  return text
    ? text
        .toString()
        .toLowerCase()
        .trim()
        .replace(/\s+/g, '-')
        .replace(/[^\w\-]+/g, '')
        .replace(/\-\-+/g, '-')
    : 'article';
};
---

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>News – Whalesbook</title>
</head>

<body class="min-h-screen bg-black text-slate-50 font-sans antialiased">
  <Navbar/>

  <main class="max-w-7xl mx-auto px-6 py-12">

    <!-- SKELETON UI (loads instantly → boosts Speed Index) -->
    <ul id="articles" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
      <!-- Skeleton cards -->
      {Array.from({ length: 9 }).map(() => (
        <li class="border border-neutral-800 rounded-xl p-4 bg-neutral-900/60 animate-pulse">
          <div class="w-full h-48 bg-neutral-800 rounded-lg mb-4"></div>
          <div class="h-4 bg-neutral-800 rounded w-3/4 mb-2"></div>
          <div class="h-3 bg-neutral-800 rounded w-full mb-2"></div>
          <div class="h-3 bg-neutral-800 rounded w-2/3"></div>
        </li>
      ))}
    </ul>

    <Footer/>
  </main>

  <!-- CLIENT-SIDE FETCH FOR FASTEST PERFORMANCE -->
  <script>
    async function loadArticles() {
      try {
        const response = await fetch("https://app1.whalesbook1.shop/published-news-collection/free", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            date: "2025-12-04",
            page: 1,
            limit: 12,
            sector: "All"
          }),
        });

        const data = await response.json();
        const articles = data?.data || [];

        const container = document.getElementById("articles");

        if (!articles.length) {
          container.innerHTML = `
            <p class="text-neutral-400 text-center col-span-3 py-10">
              No articles found.
            </p>`;
          return;
        }

        container.innerHTML = articles
          .map((article) => {
            const category = createSlug(article.suggestedSector || "general");
            const slug = createSlug(article?.translations?.[0]?.headline || "untitled");
            const id = article._id;

            return `
              <li class="group border border-neutral-800 rounded-xl p-4 bg-neutral-900/60 backdrop-blur-sm transition-all duration-300 hover:bg-neutral-900 hover:border-neutral-700 hover:shadow-2xl hover:shadow-indigo-500/10">
                <a href="/news/english/${category}/${slug}/${id}" class="flex flex-col h-full">

                  <div class="overflow-hidden rounded-lg mb-4 bg-neutral-800 border border-neutral-800 relative">
                    <img
                      src="${article.imageUrl || 'https://via.placeholder.com/400x250'}"
                      alt="${article.translations?.[0]?.headline || 'Article'}"
                      class="w-full h-48 object-cover transition-transform duration-500 group-hover:scale-105"
                      loading="lazy"
                    />

                    <div class="absolute top-2 left-2 bg-black/70 backdrop-blur-md px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider text-white border border-white/10">
                      ${article.suggestedSector || 'News'}
                    </div>
                  </div>

                  <h2 class="text-xl font-bold mb-3 text-white leading-snug group-hover:text-indigo-400 transition-colors">
                    ${article.translations?.[0]?.headline || 'No title'}
                  </h2>

                  <p class="text-neutral-400 text-sm mb-6 line-clamp-3 leading-relaxed flex-grow">
                    ${article.crux || "No description available."}
                  </p>

                  <div class="mt-auto flex items-center justify-between border-t border-neutral-800 pt-3">
                    <span class="text-[10px] text-neutral-500 uppercase font-semibold tracking-wider">
                      ${new Date(article.scrappedAt || Date.now()).toLocaleDateString("en-GB", { day: "numeric", month: "short" })}
                    </span>

                    <span class="inline-flex items-center text-xs font-bold text-indigo-500 group-hover:translate-x-1 transition-transform">
                      Read Story
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 ml-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                      </svg>
                    </span>
                  </div>
                </a>
              </li>
            `;
          })
          .join("");
      } catch (err) {
        console.error("Error loading articles:", err);
      }
    }

    // Make slug utility available inside script
    function createSlug(text) {
      return text
        ? text
            .toString()
            .toLowerCase()
            .trim()
            .replace(/\s+/g, '-')
            .replace(/[^\w\-]+/g, '')
            .replace(/\-\-+/g, '-')
        : 'article';
    }

    loadArticles();
  </script>

</body>
</html>