---
// 1. SWITCH TO SSR (Server Side Rendering)
export const prerender = false;

import Navbar from "../components/Navbar.astro";
import Footer from "../components/Footer.astro";
import '../styles/global.css';

// 2. CRITICAL: ENABLE EDGE CACHING
// This tells Netlify to run the fetch ONCE, cache the HTML for 1 hour (s-maxage=3600),
// and serve it instantly to everyone else.
Astro.response.headers.set('Cache-Control', 'public, max-age=60, s-maxage=3600, stale-while-revalidate=600');
Astro.response.headers.set('Vary', 'Accept-Encoding');

// 3. SERVER-SIDE FETCH (Happens before HTML is sent)
let articles = [];
let error = null;

try {
  const response = await fetch("https://app1.whalesbook1.shop/published-news-collection/free", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      // Ideally make this dynamic, e.g., new Date().toISOString().split('T')[0]
      date: "2025-12-04", 
      page: 1,
      limit: 12,
      sector: "All"
    }),
  });
  const data = await response.json();
  articles = data?.data || [];
} catch (e) {
  console.error("Fetch error:", e);
  error = true;
}

// Utility for Slug
const createSlug = (text) => {
  return text
    ? text.toString().toLowerCase().trim()
        .replace(/\s+/g, '-')
        .replace(/[^\w\-]+/g, '')
        .replace(/\-\-+/g, '-')
    : 'article';
};
---

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>News â€“ Whalesbook</title>
  <meta name="description" content="Latest market news and updates from Whalesbook." />
  
  <!-- Preload LCP Image if available (The first article) -->
  {articles.length > 0 && (
    <link rel="preload" as="image" href={articles[0].imageUrl} fetchpriority="high" />
  )}

  <style>
    /* Critical CSS */
    :root{color-scheme:dark}
    body { background-color: #000; color: #f8fafc; }
    /* Ensure images take up space immediately to prevent CLS */
    .card-img { width: 100%; height: 192px; object-fit: cover; background-color: #171717; }
  </style>
</head>

<body class="min-h-screen bg-black text-slate-50 font-sans antialiased">
  <Navbar/>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 py-8 md:py-12">
    
    <h1 class="text-3xl font-bold text-white mb-8 border-l-4 border-indigo-500 pl-4">Latest Market News</h1>

    {articles.length === 0 ? (
      <div class="text-center py-20 text-neutral-400">
        <p>No articles found at the moment.</p>
      </div>
    ) : (
      <ul class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 md:gap-8">
        {articles.map((article, index) => {
          const category = createSlug(article.suggestedSector || "general");
          const headline = article.translations?.[0]?.headline || "Untitled";
          const slug = createSlug(headline);
          const id = article._id;
          const image = article.imageUrl || "https://via.placeholder.com/400x250";
          
          // Optimization: First image loads eagerly (LCP), others lazy
          const isLCP = index === 0;

          return (
            <li class="group bg-neutral-900/40 border border-neutral-800 rounded-xl overflow-hidden hover:border-neutral-600 transition duration-300 flex flex-col h-full">
              <a href={`/news/english/${category}/${slug}/${id}`} class="flex flex-col h-full focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-xl">
                
                <div class="relative overflow-hidden">
                  <img
                    src={image}
                    alt={headline}
                    width="400"
                    height="192"
                    class="card-img group-hover:scale-105 transition-transform duration-500 ease-out"
                    loading={isLCP ? "eager" : "lazy"}
                    decoding="async"
                    fetchpriority={isLCP ? "high" : "auto"}
                  />
                  <div class="absolute top-2 left-2 bg-black/80 backdrop-blur-md px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider text-white border border-white/10">
                    {article.suggestedSector || 'News'}
                  </div>
                </div>

                <div class="p-5 flex flex-col flex-grow">
                  <h2 class="text-lg font-bold mb-3 text-slate-100 leading-snug group-hover:text-indigo-400 transition-colors">
                    {headline}
                  </h2>

                  <p class="text-slate-400 text-sm mb-4 line-clamp-3 leading-relaxed flex-grow">
                    {article.crux || "No description available."}
                  </p>

                  <div class="mt-auto flex items-center justify-between border-t border-neutral-800 pt-3">
                    <span class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">
                      {new Date(article.scrappedAt || Date.now()).toLocaleDateString("en-GB", { day: "numeric", month: "short" })}
                    </span>

                    <span class="inline-flex items-center text-xs font-bold text-indigo-400 group-hover:translate-x-1 transition-transform">
                      Read Story
                      <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 ml-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                      </svg>
                    </span>
                  </div>
                </div>
              </a>
            </li>
          );
        })}
      </ul>
    )}

    <Footer/>
  </main>
</body>
</html>