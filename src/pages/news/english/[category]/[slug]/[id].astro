---
export const prerender = false;

import '../../../../../styles/global.css';
import { fetchNewsDetails } from "../../../../../services/fetchNewsDetails";
import AppBanner from "../../../../../components/Appbanner.astro";
import StocksList from "../../../../../components/stocks.astro";
import NewsList from "../../../../../components/newslist.astro";
import Footer from "../../../../../components/Footer.astro";
import Navbar from "../../../../../components/Navbar.astro";

const { id } = Astro.params;

// Ultra-fast caching for SSR responses
Astro.response.headers.set('Cache-Control', 'public, max-age=30, s-maxage=600, stale-while-revalidate=600');
Astro.response.headers.set('Vary', 'Accept-Encoding');

const articleData = await fetchNewsDetails(id);
const translation = articleData?.translations?.[0] || {};

const headline = translation.headline || "Article Not Found";
const shortDescription = translation.shortDescription || "";
const detailedCoverage = translation.detailedCoverage || "";
const imageUrl = articleData?.imageUrl || "";
const newsType = articleData?.newsType || "News";
const author = articleData?.author || "Whalesbook Team";
const dateStr = articleData?.scrappedAt;

// Fast date parser
const formatDate = (isoString) =>
  isoString
    ? new Date(isoString).toLocaleDateString("en-GB", {
        month: "short",
        day: "numeric",
        year: "numeric",
        hour: "numeric",
        minute: "numeric",
      })
    : "";

// Content parser (no CLS, highly readable, WCAG compliant)
const parseContent = (text) =>
  !text
    ? ""
    : text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/^### (.*$)/gim, '<h3 class="text-xl font-bold text-white mt-8 mb-3">$1</h3>')
        .replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold text-indigo-200">$1</strong>')
        .replace(/^\* (.*$)/gim, '<div class="flex gap-3 mb-2"><span class="text-indigo-500 font-bold text-lg leading-none">•</span><span class="text-slate-200">$1</span></div>')
        .split("\n\n")
        .map((p) => {
          if (p.trim().match(/^<(h3|div)/)) return p;
          return `<p class="mb-5 leading-relaxed text-slate-200 text-base">${p.replace(/\n/g, "<br>")}</p>`;
        })
        .join("");

const contentHtml = parseContent(detailedCoverage);
---

<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{headline} – Whalesbook</title>
  <meta name="description" content={shortDescription.substring(0, 155)} />

  <link rel="canonical" href={Astro.url.href} />

  <meta property="og:title" content={headline} />
  <meta property="og:description" content={shortDescription} />
  {imageUrl && <meta property="og:image" content={imageUrl} />}

  <style is:inline>
    :root { color-scheme: dark; }
    body { background:#000; color:#e2e8f0; font-family: system-ui, -apple-system, sans-serif; }
    .reserve-img { width:100%; aspect-ratio:16/9; object-fit:cover; background:#111; display:block; }
  </style>
</head>

<body class="min-h-screen bg-black text-slate-200 antialiased pb-24">

  <Navbar/>

  <main class="px-4 sm:px-6 md:px-8 py-6 max-w-[1280px] mx-auto">
    <div class="flex flex-col md:flex-row gap-8">

      <!-- MAIN ARTICLE -->
      <article class="w-full md:w-[70%] lg:w-[75%]">

        <!-- TITLE (LCP) -->
        <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-white mb-4 leading-tight">
          {headline}
        </h1>

        <!-- META -->
        <div class="flex flex-wrap items-center text-xs font-bold tracking-wider text-gray-300 mb-6 uppercase">
          <span class="text-indigo-400">{newsType}</span>
          <span class="mx-2 text-slate-600">|</span>
          <span>{formatDate(dateStr)}</span>
        </div>

        <!-- AUTHOR -->
        <div class="flex items-center gap-3 mb-6">
          <div class="w-8 h-8 rounded-full bg-indigo-900/50 flex items-center justify-center border border-indigo-500/30">
            <span class="text-indigo-300 text-xs font-bold">WB</span>
          </div>
          <div class="flex flex-col">
            <span class="text-[10px] text-gray-400 font-bold uppercase">Written By</span>
            <span class="text-sm font-medium text-white">{author}</span>
          </div>
        </div>

        <!-- OVERVIEW (kept text-based for 0.4s LCP) -->
        <div class="bg-neutral-900/40 border border-neutral-800 rounded-lg p-5 mb-8">
          <h2 class="text-yellow-400 font-bold text-sm mb-2 uppercase tracking-wide">Overview</h2>
          <p class="text-slate-200 text-sm md:text-base leading-relaxed">{shortDescription}</p>
        </div>

        <!-- MOBILE BANNER -->
        <div class="md:hidden mb-8">
          <AppBanner />
        </div>

        <!-- MOBILE IMAGE (lazy + below fold = LCP boost) -->
        <div class="md:hidden mb-8">
          <img 
            src={imageUrl || "/placeholder.jpg"}
            alt={headline}
            class="reserve-img rounded-lg border border-neutral-800"
            loading="lazy"
            decoding="async"
            fetchpriority="low"
          />
        </div>

        <!-- DESKTOP IMAGE -->
        <div class="hidden md:block mb-8">
          <img 
            src={imageUrl || "/placeholder.jpg"}
            alt={headline}
            class="reserve-img rounded-xl border border-neutral-800"
            loading="lazy"
            decoding="async"
          />
        </div>

        <!-- ARTICLE CONTENT -->
        <div class="prose prose-invert max-w-none prose-p:text-slate-200 prose-headings:text-white">
          <div set:html={contentHtml} />
        </div>

        <!-- MOBILE READ NEXT -->
        <div class="md:hidden mt-10">
          <h3 class="text-yellow-400 font-bold text-lg mb-4">Read Next</h3>
          <NewsList limit={5} layout="col" />
        </div>

      </article>

      <!-- SIDEBAR DESKTOP -->
      <aside class="hidden md:block w-[30%] lg:w-[25%] shrink-0 space-y-8 sticky top-4">

        <AppBanner />

        <div>
          <h3 class="text-white font-bold text-lg mb-4 border-l-4 border-indigo-500 pl-3">Market Data</h3>
          <StocksList />
        </div>

        <div>
          <h3 class="text-white font-bold text-lg mb-4 border-l-4 border-yellow-500 pl-3">Latest News</h3>
          <NewsList limit={5} layout="col" />
        </div>

      </aside>

    </div>

    <!-- MORE STORIES -->
    <div class="mt-16 pt-8 border-t border-neutral-900">
      <h3 class="text-white font-bold text-xl mb-6">More Top Stories</h3>
      <NewsList layout="row" />
    </div>

    <Footer/>

  </main>
</body>
</html>