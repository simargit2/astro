---
export const prerender = false;

import '../../../../../styles/global.css';
import { fetchNewsDetails } from "../../../../../services/fetchNewsDetails";
import AppBanner from "../../../../../components/Appbanner.astro";
import StocksList from "../../../../../components/stocks.astro";
import NewsList from "../../../../../components/newslist.astro";
import Footer from "../../../../../components/Footer.astro";
import Navbar from "../../../../../components/Navbar.astro";

const { id } = Astro.params;

const articleData = await fetchNewsDetails(id);
const translation = articleData?.translations?.[0] || {};
const headline = translation.headline || "Article Not Found";
const shortDescription = translation.shortDescription || "";
const detailedCoverage = translation.detailedCoverage || "";
const imageUrl = articleData?.imageUrl || "";
const newsType = articleData?.newsType || "News";
const author = articleData?.author || "Whalesbook Team";
const dateStr = articleData?.scrappedAt;
const audioData = articleData?.audioUrl || [];

const formatDate = (isoString) => {
  if (!isoString) return "";
  const date = new Date(isoString);
  const day = date.getDate();
  const suffix =
    ["th", "st", "nd", "rd"][
      (day % 10 > 3 || [11, 12, 13].includes(day % 100)) ? 0 : day % 10
    ];

  const formattedDate = date.toLocaleDateString("en-GB", {
    month: "long",
    year: "numeric",
  });

  const formattedTime = date.toLocaleTimeString("en-US", {
    hour: "numeric",
    minute: "2-digit",
    hour12: true,
  });

  return `${day}${suffix} ${formattedDate}, ${formattedTime}`;
};

const parseContent = (text) => {
  if (!text) return "";
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/^### (.*$)/gim, '<h3 class="text-xl font-bold text-slate-100 mt-8 mb-3">$1</h3>')
    .replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold text-slate-100">$1</strong>')
    .replace(/^\* (.*$)/gim, '<li class="ml-5 list-disc marker:text-slate-500 pl-1 mb-2">$1</li>')
    .split("\n\n")
    .map((p) => {
      if (p.trim().match(/^<(h3|li)/)) return p;
      return `<p class="mb-5 leading-relaxed text-slate-300">${p.replace(/\n/g, "<br>")}</p>`;
    })
    .join("");
};

const contentHtml = parseContent(detailedCoverage);
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{headline} â€“ Whalesbook</title>
    <meta name="description" content={shortDescription} />
    <link rel="canonical" href={Astro.url.href} />
    <meta property="og:title" content={headline} />
    <meta property="og:description" content={shortDescription} />
    {imageUrl && <meta property="og:image" content={imageUrl} />}
    <meta property="og:type" content="article" />
    <meta name="twitter:card" content="summary_large_image" />
    <!-- small critical styles inline to avoid render blocking -->
    <style>
      :root{color-scheme: dark}
      .hero-title {font-weight:700;line-height:1.06}
      /* Reserve image space to avoid CLS */
      .img-reserve {width:100%;aspect-ratio:16/9;display:block;object-fit:cover}
      /* reduce repaints for audio controls */
      .audio-wrap{backface-visibility:hidden}
    </style>
  </head>

  <body class="min-h-screen bg-black text-slate-50 font-sans antialiased pb-24">
    <Navbar/>
    <main class="px-4 sm:px-6 md:px-10 py-6 md:py-12">
      <div class="flex flex-col md:flex-row justify-between items-start gap-y-10">
        <div class="w-full md:px-10">
          <!-- 1. TITLE (text-first to ensure LCP is text) -->
          <h1 class="text-2xl sm:text-3xl md:text-4xl lg:text-[2.5rem] hero-title text-white leading-tight tracking-tight mb-4">
            {headline}
          </h1>

          <div class="flex flex-wrap items-center text-xs font-semibold tracking-widest text-slate-400 mb-6 md:mb-8 uppercase">
            <span class="text-indigo-400">{newsType.toUpperCase()}</span>
            <span class="mx-3 text-slate-600">|</span>
            <span>{formatDate(dateStr)}</span>
          </div>

          <div class="flex items-center mb-6 md:mb-8">
            <div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-gradient-to-tr from-purple-600 to-indigo-600 flex items-center justify-center mr-3 shadow-lg shadow-purple-900/20">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 md:h-5 md:w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="flex flex-col">
              <span class="text-[9px] md:text-[10px] text-indigo-300 font-bold uppercase tracking-wider mb-0.5">Author</span>
              <div class="text-sm font-medium text-slate-200">
                {author} <span class="text-slate-500 font-normal text-xs">| Whalesbook News Team</span>
              </div>
            </div>
          </div>

          <!-- OVERVIEW (render right after title so text is LCP) -->
          <div class="bg-black/80 border border-neutral-800 rounded-xl p-4 md:p-6 mb-8 md:mb-10 backdrop-blur-sm">
            <h2 class="text-yellow-400 font-bold text-base md:text-lg mb-2 md:mb-3 border-b border-yellow-400/20 pb-1 inline-block">
              Overview
            </h2>
            <p class="text-slate-300 leading-relaxed text-sm md:text-base lg:text-lg">
              {shortDescription}
            </p>
          </div>

          <!-- MOBILE IMAGE: intentionally moved AFTER overview to make LCP text-based -->
          <div class="md:hidden flex flex-col items-center mb-6">
            <figure class="w-full rounded-xl overflow-hidden shadow-xl border border-neutral-800">
              <img
                src={imageUrl || "https://via.placeholder.com/800x450"}
                alt={headline}
                class="img-reserve"
                loading="lazy"
                decoding="async"
                width="800"
                height="450"
              />
            </figure>
          </div>

          <!-- 3. AUDIO (Mobile: after mobile image) -->
          {audioData.length > 0 && (
            <div class="md:hidden w-full mb-6 audio-wrap">
              <div class="w-full bg-neutral-900/80 border border-neutral-800 rounded-xl p-3 backdrop-blur-sm">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2 mb-3 border-b border-neutral-800 pb-2">
                  <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                    <span class="text-xs font-bold uppercase tracking-widest text-slate-400">Audio Article</span>
                  </div>

                  <select
                    id="audio-lang-select"
                    class="bg-black/80 border border-neutral-700 text-slate-300 text-xs rounded px-3 py-1 outline-none focus:border-indigo-500 cursor-pointer w-full sm:w-auto"
                  >
                    {audioData.map((audio) => (
                      <option value={audio.audioUrl} class="capitalize">{audio.language}</option>
                    ))}
                  </select>
                </div>

                <audio id="main-audio-player" controls class="w-full h-8 block custom-audio">
                  <source src={audioData[0]?.audioUrl} type="audio/mpeg" />
                  Your browser does not support the audio element.
                </audio>
              </div>
            </div>
          )}

          <!-- 4. BANNER (Mobile) -->
          <div class="md:hidden w-full mb-8">
            <AppBanner />
          </div>

          <!-- DESKTOP IMAGE & AUDIO (desktop shows image in desktop position, lazy to avoid blocking) -->
          <div class="hidden md:flex flex-col items-center mb-10">
            <figure class="w-full max-w-2xl rounded-xl overflow-hidden shadow-2xl border border-neutral-800 mb-6">
              <img
                src={imageUrl || "https://via.placeholder.com/800x450"}
                alt={headline}
                class="img-reserve"
                loading="lazy"
                decoding="async"
                width="1200"
                height="675"
              />
            </figure>

            {audioData.length > 0 && (
              <div class="w-full max-w-2xl bg-neutral-900/80 border border-neutral-800 rounded-xl p-4 backdrop-blur-sm">
                <div class="flex items-center justify-between mb-3 border-b border-neutral-800 pb-2">
                  <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                    <span class="text-xs font-bold uppercase tracking-widest text-slate-400">Audio Article</span>
                  </div>

                  <select
                    id="audio-lang-select-desktop"
                    class="bg-black/80 border border-neutral-700 text-slate-300 text-xs rounded px-3 py-1 outline-none focus:border-indigo-500 cursor-pointer"
                  >
                    {audioData.map((audio) => (
                      <option value={audio.audioUrl} class="capitalize">{audio.language}</option>
                    ))}
                  </select>
                </div>

                <audio id="main-audio-player-desktop" controls class="w-full h-8 block custom-audio">
                  <source src={audioData[0]?.audioUrl} type="audio/mpeg" />
                  Your browser does not support the audio element.
                </audio>
              </div>
            )}
          </div>

          <!-- ARTICLE CONTENT (server-rendered, but no big images here) -->
          <article class="prose prose-sm sm:prose-base md:prose-lg prose-invert max-w-none text-slate-300 bg-black/80">
            <div set:html={contentHtml} />
          </article>

          <!-- 6. OTHER THINGS: Suggested Sector & NewsList (Mobile: After content) -->
          <div class="md:hidden w-full mt-10">
            <h2 class="text-yellow-400 font-bold text-xl mb-4">Suggested Sector</h2>
            <NewsList limit={5} layout="col" />
          </div>

        </div>

        <!-- DESKTOP ONLY: Sidebar -->
        <div class="hidden md:block w-[320px] shrink-0 sticky top-10">
          <AppBanner />
          <StocksList />
          <h2 class="text-yellow-400 font-bold text-xl mt-2">Suggested Sector</h2>
          <NewsList limit={5} layout="col" />
        </div>

      </div>

      <!-- DESKTOP NewsList row -->
      <NewsList layout="row" />

      <Footer/>
    </main>

    <!-- AUDIO SWITCH SCRIPT (deferred, non-blocking) -->
    <script type="module" defer>
      const selectMobile = document.getElementById("audio-lang-select");
      const playerMobile = document.getElementById("main-audio-player");
      const selectDesktop = document.getElementById("audio-lang-select-desktop");
      const playerDesktop = document.getElementById("main-audio-player-desktop");

      if (selectMobile && playerMobile) {
        selectMobile.addEventListener("change", (e) => {
          const newSrc = e.target.value;
          playerMobile.src = newSrc;
          playerMobile.play().catch((e) => console.log("Auto-play prevented:", e));
        });
      }

      if (selectDesktop && playerDesktop) {
        selectDesktop.addEventListener("change", (e) => {
          const newSrc = e.target.value;
          playerDesktop.src = newSrc;
          playerDesktop.play().catch((e) => console.log("Auto-play prevented:", e));
        });
      }
    </script>

    <style>
      /* Scrollbar + small performance niceties */
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: #000; }
      ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #555; }
      audio { filter: invert(1) hue-rotate(180deg) contrast(0.8); }

      /* Ensure images reserve space to avoid CLS */
      .img-reserve { display:block; width:100%; height:auto; aspect-ratio:16/9; object-fit:cover }

      /* Mobile typography tuning */
      @media (max-width: 640px) {
        .prose-sm h3 { font-size:1.125rem !important; line-height:1.75rem !important; margin-top:2rem !important; margin-bottom:0.75rem !important; }
        .prose-sm p { margin-bottom:1rem !important; font-size:0.9375rem !important; line-height:1.625 !important; }
        .prose-sm li { margin-bottom:0.5rem !important; font-size:0.9375rem !important; line-height:1.5 !important; }
      }
    </style>
  </body>
</html>