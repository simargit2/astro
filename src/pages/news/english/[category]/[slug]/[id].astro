---
export const prerender = false;

import '../../../../../styles/global.css';
import { fetchNewsDetails } from "../../../../../services/fetchNewsDetails";
import AppBanner from "../../../../../components/Appbanner.astro";
import StocksList from "../../../../../components/stocks.astro";
import NewsList from "../../../../../components/newslist.astro";
import Footer from "../../../../../components/Footer.astro";
import Navbar from "../../../../../components/Navbar.astro";

const { id } = Astro.params;

// 1. CACHING HEADERS (Keep this! It makes the server response instant after the first hit)
Astro.response.headers.set('Cache-Control', 'public, max-age=60, s-maxage=3600, stale-while-revalidate=600');
Astro.response.headers.set('Vary', 'Accept-Encoding');

const articleData = await fetchNewsDetails(id);
const translation = articleData?.translations?.[0] || {};
const headline = translation.headline || "Article Not Found";
const shortDescription = translation.shortDescription || "";
const detailedCoverage = translation.detailedCoverage || "";
const imageUrl = articleData?.imageUrl || "";
const newsType = articleData?.newsType || "News";
const author = articleData?.author || "Whalesbook Team";
const dateStr = articleData?.scrappedAt;
const audioData = articleData?.audioUrl || [];

const formatDate = (isoString) => {
  if (!isoString) return "";
  return new Date(isoString).toLocaleDateString("en-GB", {
    month: "short", day: "numeric", year: "numeric", hour: "numeric", minute: "numeric"
  });
};

const parseContent = (text) => {
  if (!text) return "";
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/^### (.*$)/gim, '<h3 class="text-lg md:text-xl font-bold text-white mt-8 mb-3">$1</h3>')
    .replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold text-indigo-200">$1</strong>')
    .replace(/^\* (.*$)/gim, '<div class="flex gap-3 ml-1 mb-2"><span class="text-indigo-500 font-bold text-lg leading-none" aria-hidden="true">•</span><span class="text-slate-300">$1</span></div>')
    .split("\n\n")
    .map((p) => {
      if (p.trim().match(/^<(h3|div)/)) return p;
      return `<p class="mb-5 leading-relaxed text-slate-300 text-base">${p.replace(/\n/g, "<br>")}</p>`;
    })
    .join("");
};

const contentHtml = parseContent(detailedCoverage);
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{headline} – Whalesbook</title>
    <meta name="description" content={shortDescription.substring(0, 155)} />
    <link rel="canonical" href={Astro.url.href} />
    <meta property="og:title" content={headline} />
    <meta property="og:description" content={shortDescription} />
    {imageUrl && <meta property="og:image" content={imageUrl} />}
    
    <style>
      :root{color-scheme:dark}
      body{background-color:#000;color:#e2e8f0}
      .hero-title{line-height:1.2;letter-spacing:-0.01em}
      .reserve-img{width:100%;height:auto;aspect-ratio:16/9;background:#111;object-fit:cover;display:block}
    </style>
  </head>

  <body class="min-h-screen bg-black text-slate-200 font-sans antialiased pb-24">
    <Navbar/>
    
    <main class="px-4 sm:px-6 md:px-8 py-6 max-w-[1280px] mx-auto">
      <div class="flex flex-col md:flex-row gap-8">
        
        <!-- MAIN COLUMN -->
        <article class="w-full md:w-[70%] lg:w-[75%] min-w-0">
          
          <!-- 1. LCP ELEMENT: H1 TEXT (Loads Instantly) -->
          <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-white mb-4 hero-title">
            {headline}
          </h1>

          <!-- Meta Row (Fixed Contrast: text-slate-400) -->
          <div class="flex flex-wrap items-center text-xs font-bold tracking-wider text-slate-400 mb-6 uppercase">
            <span class="text-indigo-400">{newsType}</span>
            <span class="mx-2 text-slate-600">|</span>
            <span>{formatDate(dateStr)}</span>
          </div>

          <!-- Author -->
          <div class="flex items-center gap-3 mb-6">
             <div class="w-8 h-8 rounded-full bg-indigo-900/50 flex items-center justify-center border border-indigo-500/30">
                <span class="text-indigo-300 text-xs font-bold">WB</span>
             </div>
             <div class="flex flex-col">
                <span class="text-[10px] text-gray-400 font-bold uppercase">Written By</span>
                <span class="text-sm font-medium text-white">{author}</span>
             </div>
          </div>

          <!-- Overview Box -->
          <div class="bg-neutral-900/40 border border-neutral-800 rounded-lg p-5 mb-8">
             <h2 class="text-yellow-400 font-bold text-sm mb-2 uppercase tracking-wide">Overview</h2>
             <p class="text-slate-300 text-sm md:text-base leading-relaxed">{shortDescription}</p>
          </div>

          <!-- 2. MOBILE STRATEGY: BANNER FIRST -->
          <!-- We place the banner BEFORE the image on mobile. This pushes the heavy image down. -->
          <div class="md:hidden mb-8">
            <AppBanner />
          </div>

          <!-- 3. MOBILE IMAGE: PUSHED DOWN -->
          <!-- It is now below the fold. It is no longer the LCP element. -->
          <div class="md:hidden mb-8">
            <img 
              src={imageUrl || "/placeholder.jpg"} 
              alt={headline} 
              width="800" 
              height="450" 
              class="reserve-img rounded-lg border border-neutral-800"
              loading="lazy" 
              decoding="async"
              fetchpriority="low"
            />
          </div>

          <!-- DESKTOP IMAGE (Hidden on Mobile) -->
          <div class="hidden md:block mb-8">
             <img 
              src={imageUrl || "/placeholder.jpg"} 
              alt={headline} 
              width="800" 
              height="450" 
              class="reserve-img rounded-xl border border-neutral-800"
              loading="eager" 
              decoding="async" 
            />
          </div>

          <!-- Content -->
          <div class="prose prose-invert max-w-none prose-p:text-slate-300 prose-headings:text-white">
            <div set:html={contentHtml} />
          </div>

          <!-- Mobile Suggestions -->
          <div class="md:hidden mt-10">
             <h3 class="text-yellow-400 font-bold text-lg mb-4">Read Next</h3>
             <NewsList limit={5} layout="col" />
          </div>
        </article>

        <!-- SIDEBAR -->
        <aside class="hidden md:block w-[30%] lg:w-[25%] shrink-0 space-y-8 sticky top-4 h-fit">
           <AppBanner />
           <div>
              <h3 class="text-white font-bold text-lg mb-4 border-l-4 border-indigo-500 pl-3">Market Data</h3>
              <StocksList />
           </div>
           <div>
              <h3 class="text-white font-bold text-lg mb-4 border-l-4 border-yellow-500 pl-3">Latest News</h3>
              <NewsList limit={5} layout="col" />
           </div>
        </aside>

      </div>

      <div class="mt-16 pt-8 border-t border-neutral-900">
        <h3 class="text-white font-bold text-xl mb-6">More Top Stories</h3>
        <NewsList layout="row" />
      </div>

      <Footer/>
    </main>

    <!-- Simple Audio Script if needed -->
    <script type="module">
      window.addEventListener('load', () => {
         // Logic for audio player if you add it back
      });
    </script>
  </body>
</html>