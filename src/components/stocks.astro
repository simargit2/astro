---
import "../styles/global.css";
import { getStocks } from "../services/fetchStocks.js";

const initialStocks = await getStocks("");
---

<div class="w-full bg-neutral-900/50 border border-neutral-800 rounded-xl p-4">
  <div id="app">

    <input
      id="searchInput"
      placeholder="Search stocks..."
      class="w-full bg-black border border-neutral-700 px-3 py-2 rounded-lg text-sm text-white focus:outline-none focus:border-indigo-500 transition-colors"
    />

    <div class="flex mt-3 bg-black rounded-lg overflow-hidden border border-neutral-800 p-0.5">
      <button id="allTab" class="flex-1 py-1.5 text-xs font-medium text-center bg-neutral-800 text-white rounded-md transition-all">
        All
      </button>
      <button id="watchlistTab" class="flex-1 py-1.5 text-xs font-medium text-center white hover:text-gray-300 transition-all">
        Watchlist
      </button>
    </div>

    <div id="watchlistView" class="hidden mt-6 text-center">
      <p class="white text-sm">Signup to add to watchlist</p>
    </div>

    <div
      id="stocksList"
      class="mt-4 space-y-2 max-h-[400px] overflow-y-auto scrollbar-thin scrollbar-thumb-neutral-700 scrollbar-track-transparent pr-1"
    >
      {initialStocks.map(stock => (
        <div class="group bg-black/40 hover:bg-neutral-800 border border-neutral-800/50 transition rounded-lg px-1 py-2 flex justify-between items-center gap-2">
          <div class="min-w-0 flex flex-row items-center">
            <p class="text-slate-200 text-sm font-medium">{stock.securityName}</p>
            <p class="white text-xs">({stock.bseCode})</p>
          </div>

          <button class="shrink-0 flex items-center justify-center w-7 h-7 border border-neutral-700 text-neutral-400 hover:text-green-400 hover:border-green-500 hover:bg-green-500/10 rounded-md transition-all" title="Add to Watchlist">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
          </button>
        </div>
      ))}
    </div>

  </div>
</div>

<script>
  // Debounce delay
  let debounceTimer = null;

  const searchInput = document.getElementById("searchInput");
  const allTab = document.getElementById("allTab");
  const watchlistTab = document.getElementById("watchlistTab");
  const stocksList = document.getElementById("stocksList");
  const watchlistView = document.getElementById("watchlistView");

  async function fetchStocks(query = "") {
    const url = `/api/get-stocks?q=${encodeURIComponent(query)}`;
    const res = await fetch(url);
    return await res.json();
  }

  function switchTab(tab) {
    if (tab === "all") {
      allTab.classList.add("bg-neutral-800", "text-white");
      allTab.classList.remove("white");

      watchlistTab.classList.remove("bg-neutral-800", "text-white");
      watchlistTab.classList.add("white");

      watchlistView.classList.add("hidden");
      stocksList.classList.remove("hidden");
    } else {
      watchlistTab.classList.add("bg-neutral-800", "text-white");
      watchlistTab.classList.remove("white");

      allTab.classList.remove("bg-neutral-800", "text-white");
      allTab.classList.add("white");

      stocksList.classList.add("hidden");
      watchlistView.classList.remove("hidden");
    }
  }

  // Tab events
  allTab.addEventListener("click", () => switchTab("all"));
  watchlistTab.addEventListener("click", () => switchTab("watchlist"));

  // Search input with debounce
  searchInput.addEventListener("input", () => {
    clearTimeout(debounceTimer);

    debounceTimer = setTimeout(async () => {
      const q = searchInput.value.trim();
      const results = await fetchStocks(q);

      // Updated InnerHTML to match new compact UI design
      stocksList.innerHTML = results
        .map(
          (s) => `
        <div class="group bg-black/40 hover:bg-neutral-800 border border-neutral-800/50 transition rounded-lg px-3 py-2 flex justify-between items-center gap-2">
          <div class="min-w-0">
            <p class="text-slate-200 text-sm font-medium truncate">${s.securityName}</p>
            <p class="white text-xs">${s.bseCode}</p>
          </div>
          <button class="shrink-0 flex items-center justify-center w-7 h-7 border border-neutral-700 text-neutral-400 hover:text-green-400 hover:border-green-500 hover:bg-green-500/10 rounded-md transition-all" title="Add to Watchlist">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
          </button>
        </div>
      `
        )
        .join("");
    }, 350);
  });
</script>